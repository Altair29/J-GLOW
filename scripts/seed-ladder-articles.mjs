import { createClient } from '@supabase/supabase-js';
import { readFileSync } from 'fs';

// .env.local を手動パース
const envContent = readFileSync('.env.local', 'utf-8');
const envVars = {};
for (const line of envContent.split('\n')) {
  const m = line.match(/^([^#=]+)="?([^"]*)"?$/);
  if (m) envVars[m[1].trim()] = m[2].trim();
}

const supabase = createClient(
  envVars.NEXT_PUBLIC_SUPABASE_URL,
  envVars.SUPABASE_SERVICE_ROLE_KEY
);

async function main() {
  // 1) カテゴリ upsert
  const categories = [
    { slug: 'sodateru-stage1', name: '育てる（Stage 1）', description: '受入れ直後〜基礎固めフェーズの記事', sort_order: 10, is_active: true },
    { slug: 'sodateru-stage2', name: '育てる（Stage 2）', description: '移行・試験対策フェーズの記事', sort_order: 20, is_active: true },
  ];

  for (const cat of categories) {
    const { error } = await supabase
      .from('blog_categories')
      .upsert(cat, { onConflict: 'slug' });
    if (error) {
      console.error('カテゴリ upsert エラー:', cat.slug, error);
      process.exit(1);
    }
  }
  console.log('✅ カテゴリ登録完了');

  // 2) カテゴリIDを取得
  const { data: cats } = await supabase
    .from('blog_categories')
    .select('id, slug')
    .in('slug', ['sodateru-stage1', 'sodateru-stage2']);

  const catMap = Object.fromEntries(cats.map(c => [c.slug, c.id]));
  console.log('カテゴリID:', catMap);

  // 3) author_id を取得（admin ユーザー優先）
  let { data: admins } = await supabase
    .from('profiles')
    .select('id')
    .eq('role', 'admin')
    .limit(1);

  let authorId;
  if (admins && admins.length > 0) {
    authorId = admins[0].id;
  } else {
    const { data: anyUser } = await supabase
      .from('profiles')
      .select('id')
      .limit(1);
    authorId = anyUser[0].id;
  }
  console.log('author_id:', authorId);

  // 4) 記事データ
  const articles = [
    {
      title: '「育てる」がはじまる3ヶ月──受入れ直後に差がつくOJT設計の考え方',
      slug: 'ojt-design-first-3months',
      excerpt: '外国人スタッフが入国してから最初の3ヶ月は、3年間の定着を左右する最重要期間です。育成就労・特定技能を問わず、企業が今すぐ整えるべきOJT設計の考え方とチェックポイントを解説します。',
      category_id: catMap['sodateru-stage1'],
      author_id: authorId,
      status: 'published',
      is_pinned: false,
      published_at: new Date().toISOString(),
      cover_image_url: null,
      body: `## なぜ「最初の3ヶ月」が3年間を決めるのか

外国人スタッフを受け入れた企業の多くが、入国から数ヶ月以内に「思っていたより大変だった」と感じます。しかし離職データを見ると、実は外国人スタッフの定着率は日本人より高い傾向があります。

出入国在留管理庁のデータによると、特定技能1号の3年半以内離職率は**16.1%**。一方、厚生労働省が発表した日本人新卒社員の3年以内離職率は**30%以上**です。外国人材は、適切な環境さえ整えれば、むしろ長く働いてくれる人材なのです。

では、なぜ「うまくいかない」と感じる企業が出るのでしょうか。多くの場合、問題は「受入れ直後のOJT設計」にあります。

---

## 2027年からの育成就労制度で変わること

2027年4月1日に施行される育成就労制度では、企業の育成責任が技能実習より明確に問われるようになります。

特に重要な変化が2点あります。

**①育成就労計画の認定が義務化**
外国人を受け入れる企業は、1人ひとりに「育成就労計画」を作成し、外国人育成就労機構の認定を受ける必要があります。「入れて、現場に放り込む」では認定を受けられなくなります。

**②日本語教育の支援が義務に**
入国時にN5相当の日本語力が求められ、3年間でN4（特定技能1号移行要件）まで伸ばすことが企業に求められます。企業は「A2目標講習」の受講機会を提供する義務を負います。

つまり、2027年以降に育成就労で人を受け入れる企業は、最初の3ヶ月から計画的なOJTと日本語教育を実施しないと、制度上の要件を満たせなくなります。

---

## OJT設計の3つの原則

### 原則1：「できること」から積み上げる

入国直後のスタッフに最初から難しい業務をアサインしても、本人も職場も疲弊します。最初の1ヶ月は「確実にできる業務を、確実にこなす経験」を積ませることが最優先です。

業務の難易度を3段階に分け、段階的にステップアップするスケジュールを最初に作っておくことが重要です。

### 原則2：「言葉」より「見せる」

入国直後のスタッフはN5レベルの日本語力しかない場合がほとんどです。N5は「ひらがな・カタカナが読め、簡単な挨拶ができる」程度のレベルです。

この段階では、口頭説明より「実際にやって見せる」「写真や動画で手順を示す」ほうが圧倒的に効果的です。業務マニュアルを「やさしい日本語」と図解で作成しておくことが、後々の教育コストを大幅に削減します。

### 原則3：「相談できる人」を作る

孤立が離職の最大の原因です。業務の相談先と、生活の相談先を最初に明確にしておくことが重要です。同じ国籍の先輩スタッフがいる場合は積極的にメンターとして活用しましょう。

---

## 受入れ直後3ヶ月のチェックリスト

### 入国前〜入国1週間以内

- [ ] 住居の準備（布団・調理器具・生活用品）
- [ ] 市区町村役所での住民票登録（入国後14日以内に義務）
- [ ] 銀行口座の開設サポート（在留カード取得後に手続き可能）
- [ ] スマートフォンのSIM契約サポート
- [ ] 社会保険・雇用保険の加入手続き
- [ ] 給与振込口座の確認
- [ ] 緊急連絡先・体調不良時の対応フローの説明

### 1ヶ月目：基礎固め

- [ ] 業務手順の「見せる型」OJTの実施（口頭説明依存をなくす）
- [ ] やさしい日本語で作成した業務マニュアルの提供
- [ ] 週1回の1on1面談の実施（体調・困りごとの確認）
- [ ] 日本語学習の環境整備（教材の提供、学習時間の確保）
- [ ] 職場のルール・安全事項の説明（母国語資料があれば活用）

### 2〜3ヶ月目：定着の確認

- [ ] 業務習熟度の確認と次のステップへの移行
- [ ] 日本語学習の進捗確認（N5レベルから着実に向上しているか）
- [ ] 職場の人間関係の確認（孤立していないか）
- [ ] 特定技能移行に向けた試験スケジュールの共有・説明
- [ ] 育成就労計画（2027年以降）に沿った育成目標の確認

---

## やりがちなNG行動

**× 「なんとなく慣れるだろう」で放置する**
最初の3ヶ月に意図的な育成を行わないと、本人は不安を抱えたまま業務をこなすだけになります。特に問題が表面化しないうちに離職を決意するケースが多く、「突然辞めた」という印象を受けることになります。

**× 日本語のマニュアルをそのまま渡す**
業務用語が多い日本語マニュアルは、N5〜N4レベルのスタッフには読解が困難です。写真・図解を多用した「現場特化型」の資料を作ることへの投資は、長期的に教育コストを下げます。

**× キャリアパスを説明しない**
「育成就労から特定技能1号、さらに特定技能2号へ」というキャリアパスを入社時に説明することは、本人のモチベーション維持に直結します。2024年の法改正で、外食業では「キャリアアッププランの作成・交付・説明」が義務化されました。他分野でも早期に整備することを推奨します。

---

## まとめ：OJTは「コスト」ではなく「投資」

最初の3ヶ月に丁寧なOJTを実施した企業では、その後の定着率が大きく改善するケースが多く報告されています。

受入れ直後の対応は手間に感じるかもしれませんが、1人の外国人スタッフの採用・入国にかかるコストは、送出機関手数料・渡航費・住居準備費などを合わせると数十万円規模になります。そのコストを回収するためにも、入国後3ヶ月の育成設計に投資することが最もリターンの大きい行動です。

育成就労制度が本格施行される2027年4月に向けて、今から仕組みを作っておくことが、他社に先んじた人材定着につながります。`,
    },
    {
      title: '特定技能1号移行を見据えた「3年間の日本語・技能ロードマップ」',
      slug: 'tokutei-roadmap-3years',
      excerpt: '育成就労で入国したスタッフが特定技能1号に移行するには、3年間でN4取得と技能検定3級合格が必要です。どの時期に何を準備すれば良いかを逆算した、企業向けロードマップを解説します。',
      category_id: catMap['sodateru-stage2'],
      author_id: authorId,
      status: 'published',
      is_pinned: false,
      published_at: new Date().toISOString(),
      cover_image_url: null,
      body: `## 育成就労から特定技能1号へ：企業が知るべき「逆算の視点」

2027年4月から始まる育成就労制度では、在留期間は原則3年間です。この3年間で特定技能1号への移行要件を満たせないと、スタッフは帰国または在留資格の変更が必要になります。

つまり育成就労は、「3年間かけて特定技能1号を目指す制度」です。企業は入国初日から逆算して育成計画を立てる必要があります。

---

## 特定技能1号への移行に必要な2つの要件

育成就労から特定技能1号に移行するには、以下の2つの試験合格が必要です。

**① 日本語試験**
JLPT N4（または国際交流基金日本語基礎テスト JFT-Basic A2相当）に合格すること。
N4は「日常的な話題の会話が理解でき、簡単な文章が読める」レベルです。

**② 技能試験**
各業種の技能検定試験3級、または特定技能1号評価試験に合格すること。
業種によって試験の難易度・実施回数・合格率が異なります。

---

## 3年間のロードマップ（推奨スケジュール）

### 1年目：基礎の土台を作る

| 時期 | 日本語目標 | 技能目標 | 企業がやること |
|------|-----------|---------|--------------|
| 入国時 | N5相当（入国要件） | ― | 育成就労計画の作成・認定申請 |
| 3ヶ月 | N5合格確認 | 業務の基礎習得 | 教材提供・週1回面談 |
| 6ヶ月 | N4学習開始 | 技能検定基礎級受験 | 試験申込サポート |
| 1年 | N4合格目標 | 技能検定基礎級合格 | **転籍要件充足（転籍リスクの管理）** |

1年目の最大のポイントは「**1年経過後に転籍可能になる**」という事実への対応です。育成就労では、同一機関で1年超就労かつN5合格・技能検定基礎級合格で、本人意向の転籍が認められます。

転籍を防ぐ最善策は「転籍したいと思わせない職場環境」を作ることです。

### 2年目：試験合格に向けて本格的に動く

| 時期 | 日本語目標 | 技能目標 | 企業がやること |
|------|-----------|---------|--------------|
| 1年目終了後 | N4合格済みが理想 | 技能検定3級の学習開始 | 試験スケジュールの確認 |
| 1年半 | N4合格（最終リミット） | 技能検定3級 受験 | 受験料・交通費サポート |
| 2年 | N3学習開始（2号見据え） | 技能検定3級 合格目標 | 合格証明書の保管 |

2年目は試験合格が最重要ミッションです。特に技能試験は業種によって年数回しか実施されないため、受験機会を逃すと計画全体が数ヶ月ずれます。

**企業として整備すべきこと：**
- 試験日程を先に押さえてカレンダーに登録する
- 試験直前の1〜2週間は残業を減らし、学習時間を確保する
- 不合格だった場合の次回受験スケジュールを即座に確認する

### 3年目：移行申請と次のキャリアプランニング

| 時期 | 行動 |
|------|------|
| 2年半〜3年目 | 両試験の合格を確認・在留資格変更申請の準備 |
| 在留期限3ヶ月前 | 在留資格変更申請（特定技能1号）の書類準備開始 |
| 在留期限2ヶ月前 | 申請提出（許可まで約2〜3ヶ月かかる） |
| 特定技能1号取得後 | 特定技能2号に向けたキャリアプランの説明 |

---

## 業種別の試験難易度の目安

特定技能1号の技能測定試験は、業種によって合格率・頻度が大きく異なります。

| 分野 | 合格率の目安 | 試験頻度 | 注意点 |
|------|-----------|---------|-------|
| 製造業 | 50〜70% | 年複数回 | N4を超える日本語力があると安心 |
| 介護 | 40〜60% | 年複数回 | 専門用語が多い・N3実質必要 |
| 農業 | 比較的高め | 年複数回 | 書類準備が重要 |
| 建設 | 30〜50% | 年複数回 | 安全管理知識が問われる |
| 宿泊 | 40〜60% | 年複数回 | 接客日本語力が重要 |

※合格率はJapanJobSchool/Divership等の業界資料をもとにした目安。試験回・実施形式によって変動する

---

## 「N4は合格したが試験でつまずく」を防ぐ

よくある失敗パターンは「日本語試験は合格したが、技能試験の日本語が読めない」というケースです。

特定技能の試験問題は、業務に関する専門用語が多く含まれます。N4の一般的な語彙力だけでは不十分で、「現場で使われる日本語」への慣れが必要です。

**有効な対策：**
- 業務マニュアルを日本語で読む習慣をつける
- 朝礼や業務指示を日本語でも行う（多言語と並行して）
- 技能試験の過去問・参考テキストを入手して早めに学習を始める

---

## 育成就労計画への記載事項（2027年以降）

2027年以降に育成就労を利用する企業は、以下を「育成就労計画」に記載して認定を受ける必要があります。

- 育成の期間と目標（業務・技能・日本語能力の目標）
- 日本語教育の支援体制（A2目標講習の受講機会提供）
- 特定技能1号移行に向けた支援内容

この計画を作成する過程で、自然と「3年間のロードマップ」が整備されることになります。逆に言えば、ロードマップなしに育成就労計画の認定申請はできません。

---

## まとめ

育成就労から特定技能1号への移行は、3年間という限られた期間の中で2つの試験を合格させる必要があります。特に日本語教育は「入国後に始めれば間に合う」ではなく、**入国前から送出国での学習が始まっている**ことが重要です。

採用の時点で「この人が3年後に特定技能1号に移行できるか」を見据えた選考・育成計画を立てることが、会社にとっても外国人スタッフにとっても良い結果につながります。`,
    },
    {
      title: '特定技能2号の合格率は約30%──企業サポートが合否を分ける理由',
      slug: 'tokutei2-exam-company-support',
      excerpt: '特定技能2号の試験は、多くの分野で合格率30%以下。「実務経験7年の人が3割合格できる」水準の難しさです。なぜ企業のサポートが合否を分けるのか、分野別の戦略とともに解説します。',
      category_id: catMap['sodateru-stage2'],
      author_id: authorId,
      status: 'published',
      is_pinned: false,
      published_at: new Date().toISOString(),
      cover_image_url: null,
      body: `## 「試験に合格できない」のは本人のせいではない

特定技能2号の試験合格率は、多くの分野で**30%以下**です。

これは「実務経験7年の人が3割合格できる」水準と言われています（出典：Divership）。試験はすべて日本語（ルビなし）で出題されるため、専門知識に加えて高い日本語読解力が求められます。

合格率が低い主な原因は「専門スキルが不足しているから」ではありません。多くの場合は「日本語の試験問題が読めないから」です。

現場で長年働いてきた外国人スタッフが、試験でつまずく。この状況は、企業のサポート次第で大きく変えられます。

---

## 特定技能2号とは何か

特定技能2号は、特定技能1号の上位に位置する在留資格です。

| | 特定技能1号 | 特定技能2号 |
|--|-----------|------------|
| 在留期間 | 上限5年 | **上限なし（更新制）** |
| 家族帯同 | 不可 | **可能** |
| 永住申請 | 困難 | **可能** |
| 要件 | 技能試験＋日本語試験 | 2号試験＋リーダー経験 |

特定技能2号を取得した外国人は、更新を続けることで事実上の「無期限」で日本に在留できます。永住権の申請要件も満たせるため、企業にとっては「長期的な戦力の確保」を意味します。

2025年6月末時点で特定技能2号在留者は**3,073人**（出入国在留管理庁）。2024年末の833人から約3.7倍に急増しており、今後さらに増加が見込まれます。

---

## 2号取得の「隠れた壁」：リーダー経験の証明

試験合格と並んでよく見落とされるのが「リーダー・監督業務経験の証明」です。

各分野で求められるリーダー経験年数は以下の通りです（目安）：

| 分野 | 必要なリーダー経験 | 経験の内容 |
|------|----------------|----------|
| 製造業 | 3年以上 | 複数作業員の指導・工程管理 |
| 建設業 | 1年（215日）以上 | 職長・班長レベルの現場管理 |
| 農業 | 2年以上 | 作業指示者として後輩指導・安全管理 |
| ビルクリーニング | 2年以上 | 複数スタッフの指導・現場管理 |
| 飲食料品製造 | 2年以上 | 工程管理＋後輩への技術指導（両方必要） |
| 宿泊業 | 2年以上 | レストラン・接客・広報などでのリーダー経験 |

**重要：この経験は「辞令や職務命令書」などの書面で証明する必要があります。**「実際にやっていた」だけでは審査で認められません。書面の発行日が経験年数の起算日になります。

---

## 1号取得直後から動かないと間に合わない

特定技能1号の在留期限は最長5年です。2号取得までの逆算スケジュールを示します（製造業の例）。

\`\`\`
特定技能1号 取得
├── 【今すぐ】工程リーダーの辞令を発行する（起算日を作る）
├── 【〜1年目】日本語N3の学習開始・2号テキストの入手
├── 【〜3年目】リーダー経験3年達成・2号試験の受験資格取得
├── 【3〜4年目】2号試験受験（合格率30%。複数回受験を前提に）
└── 【4〜5年目】合格・在留資格変更申請 → 特定技能2号取得
\`\`\`

1号を取得してから「そのうち考えよう」では、試験に合格できるタイミングが来る前に5年が終わります。

---

## 企業サポートが「合否を分ける」3つの理由

### 理由1：試験は日本語力で合否が決まる

多くの分野で合格率が低い主因は「専門知識の不足」ではなく「日本語の文章が読めない」ことです。

業務指示書・報告書を日本語で書かせる、朝礼を日本語で行うなど、日常業務での日本語使用が最も効果的な試験対策になります。N3取得を目標にした学習支援が、合格率向上に直結します。

### 理由2：試験対策の時間を確保できるか

試験日が近づいても「業務が忙しいから勉強できない」という状況では合格できません。試験前の1〜2週間は残業を減らす、業務量を調整するといった会社側の配慮が必要です。

### 理由3：分野固有の追加要件への対応

製造業では「**ビジネスキャリア検定3級**（生産管理プランニングまたはオペレーション）」の取得が追加で必要です。

外食業・飲食料品製造業の2号試験は**N3相当の日本語力が実質的に必要**（外食業はJLPT N3以上が受験要件）で、N4だけでは不十分です。

分野ごとに要件が異なるため、試験実施機関の公式テキスト・要件を早期に確認することが重要です。

---

## 2025年の法改正：特例措置を知っておく

2025年の法改正により、特定技能1号の在留期限内に2号試験を受験し「**合格基準点の8割以上**」を取得した場合、最大**1年間の在留延長**が認められる特例措置が新設されました。

条件：
- 合格基準点の8割以上を取得していること
- 企業側が継続雇用の意思と試験合格支援体制を誓約すること
- 延長期間中に不合格の場合は速やかな帰国が求められる

5年以内に合格できなかった場合でも、あと1回チャンスがある制度です。ただし「延長に頼る」のではなく、5年以内の合格を目標に早期から準備することが重要です。

---

## 分野別：合格率を上げるための戦略

### 製造業
合格率30〜40%程度。ビジネスキャリア検定3級の取得が必須のため、早期にテキストを入手して学習を開始させる。日本語の業務文書作成の習慣化が試験対策に直結する。

### 建設業
合格率20〜30%で最難関クラス。安全管理・工程管理の専門知識を日本語で答える必要がある。職長教育の受講と、日本語N3取得が事実上の前提条件。

### 介護
特定技能2号ではなく「介護」在留資格への移行が本命ルート。介護福祉士国家試験（年1回・1月）への合格が必要で、受験資格に実務経験3年＋実務者研修修了が必要。2年目から実務者研修を開始することを推奨。

### 飲食料品製造・外食業
他分野より合格率が高め（40〜60%程度）。OTAFFが公開している学習テキストを活用し、計画的に学習を進めれば合格可能。

### 宿泊業
合格率は30%前後。現場スキルより日本語力が合否を分ける典型例。N3合格を最優先に。

---

## まとめ：2号取得は「会社の姿勢」が決める

特定技能2号の取得率が低い最大の原因は、「会社が試験合格を他人事にしている」ことです。

個人任せにしている企業の合格率は低く、会社として日本語学習・試験対策を積極的にサポートしている企業の合格者が多いというのが現場の実態です。

特定技能2号を取得したスタッフは、在留期限なしで長期的に在籍できます。採用・育成にかかったコストを回収し、さらに長く貢献してもらうためにも、企業として2号取得を「会社の目標」として位置づけることが、外国人雇用を成功させる鍵です。`,
    },
  ];

  // 5) 記事を1件ずつ upsert
  for (const article of articles) {
    // 既存チェック
    const { data: existing } = await supabase
      .from('blog_posts')
      .select('id')
      .eq('slug', article.slug)
      .maybeSingle();

    if (existing) {
      // 更新
      const { error } = await supabase
        .from('blog_posts')
        .update({
          title: article.title,
          body: article.body,
          excerpt: article.excerpt,
          category_id: article.category_id,
          status: article.status,
          published_at: article.published_at,
        })
        .eq('id', existing.id);
      if (error) {
        console.error('記事更新エラー:', article.slug, error);
        process.exit(1);
      }
      console.log(`✅ 記事更新: ${article.slug} (id: ${existing.id})`);
    } else {
      // 新規作成
      const { data, error } = await supabase
        .from('blog_posts')
        .insert(article)
        .select('id')
        .single();
      if (error) {
        console.error('記事作成エラー:', article.slug, error);
        process.exit(1);
      }
      console.log(`✅ 記事作成: ${article.slug} (id: ${data.id})`);
    }
  }

  // 6) 確認
  const { data: result } = await supabase
    .from('blog_posts')
    .select('id, title, slug, status, published_at, category_id, blog_categories(name)')
    .in('slug', ['ojt-design-first-3months', 'tokutei-roadmap-3years', 'tokutei2-exam-company-support']);

  console.log('\n📋 登録確認:');
  for (const r of result) {
    console.log(`  - [${r.status}] ${r.title} (slug: ${r.slug}, category: ${r.blog_categories?.name || 'なし'})`);
  }
  console.log(`\n✅ 全${result.length}件の登録が完了しました`);
}

main().catch(console.error);
